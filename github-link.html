<!DOCTYPE html>
<html lang="pt" dir="ltr">

<head>
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="/css/master.css">
  <meta charset="utf-8">
  <link rel="shortcut icon" href="assets/favicon.ico">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <title>Marvin</title>
  <script src="./helper.js" charset="utf-8"></script>
</head>

<body>
  <main class="fullwidth">
    <div class="login">
      <h3>Parece que esse é seu primeiro acesso.
        <br>
        <br>
        <a href="https://app.projetomarvin.com/assets/pdf/Marvin+-+fase+00.pdf" target="_blank">Clique aqui</a> para ver as instruções. 
        </h3>
      <form class="loginForm">
        <input type="text" name="username" placeholder="usuário do Github" />
        <br>
        <button type="submit" class="full-green">continuar</button>
      </form>
    </div>
  </main>
  <script type="text/javascript">
    $('.loginForm').on('submit', function(e) {
      e.preventDefault()
      const usr = $('input[name=username]').val();
      $.ajax({
        type: 'get',
        url: url + 'students/' + localStorage.userId + '/checkRepository' + '?username=' + usr + '&access_token=' + localStorage.access_token,
        crossDomain: true,
        success: function(responseData, textStatus, jqXHR) {
          console.log(responseData);
          if (responseData === "not found") {
            alert('Usuário ou repositório não encontrado. Verifique e tente novamente.')
          } else {
            console.log(responseData);
            alert('Conta vinculada com sucesso e você conseguiu suas primeiras 42 moedas! Agora você deve vincular sua conta com o Github.')
            window.location.href = 'https://github.com/login/oauth/authorize?client_id=71f8116e373c16f3eb11&scope=repo&login=' + usr;
          }
        },
        error: function(responseData, textStatus, errorThrown) {
          console.log(responseData);
          alert('Algo deu errado, tente novamente.');
        }
      })
    })

    $(document).ready(function() {
      const userId = location.search.substring(1);
      const pwd = prompt('LEIA COM ATENÇÃO!\nParece que esse é seu primeiro acesso. ' +
        'Para mudar sua senha, digite uma nova senha no campo abaixo. Caso queira' +
        'continiar com a atual, clique em cancelar duas vezes.')
      const pwd2 = prompt('Agora confirme sua nova senha');
      if (pwd && pwd === pwd2) {
        $.ajax({
          type: 'post',
          url: url + 'students/reset-password?access_token=' + localStorage.access_token,
          data: {newPassword: pwd},
          crossDomain: true,
          success: function(responseData, textStatus, jqXHR) {
            console.log(responseData);
            alert("Senha alterada com sucesso!")
          },
          error: function(responseData, textStatus, errorThrown) {
            console.log(responseData);
            alert('Algo deu errado, tente novamente.');
          }
        })
      } else {
        alert('As senhas digitadas não conferem ou você cancelou. ' +
        'Caso queira tentar novamente, recerregue a página.')
      }
    })
  </script>
</body>

</html>
