<!DOCTYPE html>
<html lang="pt">

<head>
  <title>Marvi - Editor</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="/css/master.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
  <link rel="shortcut icon" href="assets/favicon.ico">
</head>

<body>
  <div id="saveDialog" style="display:none">
    <div class="dialog">
      <button id="closeButton">&times;</button>
      <h2>
        Como você deseja salvar seu código?
      </h2>
      <div class="buttons">
        <button onclick="download()" class="purple">
          Baixar <span class="icon">&#11015;</span>
        </button>
        <button onclick="github()" class="purple">
          Github <img src="assets/github.svg" alt="">
        </button>
      </div>
      <div class="githubPath" hidden>
        <input type="text" name="githubPath" placeholder="caminho e nome do arquivo">
        <br>
        <input type="text" name="message" placeholder="mensagem do commit">
        <br>
        <br>
        <button class="green" onclick="saveGithub()">Salvar</button>
      </div>
      <br>
      <p style="color: darkred;">LEMBRE-SE DE NÃO INCLUIR A LINHA DE INVOCAÇÃO DA FUNÇÃO</p>
    </div>
  </div>
  <div class="container">
    <div class="half">
      <header class="header editor">
        <a class="white_back" href="/home.html">
          &#11013;
        </a>
        <p>Editor javascript</p>
      </header>
      <div id="editor" />
    </div>
    <footer class="footer">
      <button onclick="run()" class="green">
        Executar <span class="icon">&#9654;</span>
      </button>
      <button onclick="reset()" class="rose">
        Reiniciar <span class="icon">&#8634;</span>
      </button>
      <button onclick="save()" class="purple">
        Salvar arquivo <span class="icon">&#11015;</span>
      </button>
    </footer>
  </div>
  <div class="half">
    <header class="header console">
      Saída do console
      <button onclick="clearConsole()" class="wine">
        Limpar
      </button>
    </header>
    <div id="log"></div>
  </div>
  </div>

  <script>
    const editor = ace.edit("editor");
    const logger = document.getElementById('log');
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/javascript");
    editor.setBehavioursEnabled(false);

    document.onkeyup = function(e) {
      if (e.ctrlKey && e.which === 13) {
        run()
      } else if (e.altKey && e.which === 83) {
        e.preventDefault();
        save();
      }
    };

    function save() {
      $('#saveDialog').show();
    }

    $('#closeButton').click(() => {
      $('#saveDialog').toggle();
    })

    function github() {
      $('.githubPath').toggle();
    }

    function saveGithub() {
      const code = editor.getValue();
      const path = $('input[name=githubPath]').val()
      const msg = $('input[name=message]').val()
      $.ajax({
        type: 'post',
        url: 'https://localhost/api/students/' + localStorage.userId + '/pushToGit?access_token=' + localStorage.access_token,
        crossDomain: true,
        data: {content: btoa(code), path: path, message: msg},
        success: function (res, txt, jsXHR) {
          console.log(res);
          alert('Commit criado com sucesso! Veja em seu repositório');
          $('#saveDialog').toggle();
          $('.githubPath').toggle();
          $('input[name=githubPath]').val("");
          $('input[name=message]').val("");
        },
        error: function (res, txt, jsXHR) {
          console.log(res);
        },
      })
    }

    function addToLog(msg, err) {
      if (err) {
        logger.innerHTML = '<p class="error log">' + msg + '</p>' + logger.innerHTML;
      } else {
        logger.innerHTML = '<p class="log">' + msg + '</p>' + logger.innerHTML;
      }
    }

    (function() {
      console.log = function(message) {
        if (typeof message == 'object') {
          addToLog(JSON && JSON.stringify ? JSON.stringify(message) : message);
        } else {
          addToLog(message)
        }
      }
    })();

    window.onerror = function(msg) {
      if (typeof msg == 'object') {
        addToLog(JSON && JSON.stringify ? JSON.stringify(msg) : msg, true);
      } else {
        addToLog(msg, true);
      }
    }

    function reset() {
      logger.innerHTML = "";
      editor.setValue("");
    }

    function clearConsole() {
      logger.innerHTML = "";
    }

    function run() {
      var code = editor.getValue();
      $("#script").remove();
      var script = document.createElement('script');
      script.setAttribute('id', "script");
      try {
        script.appendChild(document.createTextNode(code));
        document.body.appendChild(script);
      } catch (e) {
        script.text = code;
        document.body.appendChild(script);
      }
    }

    function download() {
      const code = editor.getValue();
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/javascript;charset=utf-8,' + encodeURIComponent(code));
      element.setAttribute('download', "file.js");

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }

  </script>
</body>

</html>
